#!/usr/bin/env ruby

require 'erb'
require 'gallery_generator'

include GalleryGenerator

OUTPUT_FILE = "index.html"
DEFAULT_GALLERY_CONFIG_FILE = "gallery.yaml"

puts "Gallery Generator"
puts "www.m1key.me"
puts "This generates a m1key.me style gallery HTML code."
puts

if ARGV.size == 0
  gallery_config_file = DEFAULT_GALLERY_CONFIG_FILE
  puts "Gallery config file not specified. Using [#{DEFAULT_GALLERY_CONFIG_FILE}]."
else
  gallery_config_file = ARGV[0]
  puts "Using gallery config file [#{gallery_config_file}]."
end

puts

gallery_config = GalleryConfig.new(gallery_config_file)
viewable_photos = photos_config_into_viewable_photos(gallery_config)

gallery = ViewableGallery.new(gallery_config.title, gallery_config.description, gallery_config.slug, \
  gallery_config.sources, gallery_config.upload_date, gallery_config.map_url, gallery_config.map_title, \
  gallery_config.year, viewable_photos).
  update_using( \
    GalleryGenerator.add_tabs_before_every_description_line(2), \
    GalleryGenerator.add_links_to_descriptions, \
    GalleryGenerator.for_each_photo(&GalleryGenerator.add_tabs_before_every_description_line(3)), \
    GalleryGenerator.for_each_photo(&GalleryGenerator.add_links_to_descriptions), \
    GalleryGenerator.for_each_photo(&GalleryGenerator.remove_final_empty_line_from_description))

puts "Writing gallery file #{OUTPUT_FILE}..."
template_file = File.open("#{File.dirname(File.expand_path($0))}/../lib/gallery_generator/template.erb", 'r').read
erb = ERB.new(template_file, nil, '-')
File.open("index.html", 'w+') { |file| file.write(erb.result(gallery.get_binding)) }

puts "#{OUTPUT_FILE} written."

